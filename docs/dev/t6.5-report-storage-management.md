# T6.5 리포트 저장 및 목록 관리

## 완료 일자
2026-02-14

## 구현 내용

### 1. Server Actions (`src/app/(dashboard)/reports/actions.ts`)
Supabase Storage를 활용한 리포트 저장/조회/삭제 기능 구현.

#### 주요 함수
- `saveReport(params)`: PDF를 Supabase Storage에 저장
  - Path 구조: `{user_id}/{order_id}/{type}_{timestamp}.pdf`
  - Bucket 자동 생성 (10MB 파일 크기 제한)
  - 메타데이터 조회 및 SavedReport 객체 반환

- `getReports(params)`: 저장된 리포트 목록 조회
  - orderId/type 필터 지원
  - 폴더 구조 탐색하여 전체 리포트 목록 생성
  - 파일명 파싱: `{type}_{timestamp}.pdf`

- `deleteReport(reportId)`: 리포트 삭제
  - 모든 폴더를 탐색하여 파일 찾기
  - Storage에서 파일 제거

- `getReportDownloadUrl(reportId)`: 다운로드 URL 생성
  - Signed URL (1시간 유효)
  - 브라우저에서 직접 다운로드 가능

#### Storage 구조
```
reports (bucket)
└── {user_id}/
    └── {order_id}/
        ├── quotation_{timestamp}.pdf
        └── checklist_{timestamp}.pdf
```

**중요**: DB 테이블 없이 Supabase Storage 메타데이터만으로 관리.

### 2. 리포트 목록 페이지 (`src/app/(dashboard)/reports/page.tsx`)
Server Component로 구현된 리포트 목록 페이지.

- `getReports()` 호출하여 전체 리포트 조회
- 타입 필터 지원 (searchParams.type)
- 총 리포트 개수 표시
- `ReportList` 컴포넌트에 데이터 전달

### 3. 리포트 목록 컴포넌트 (`src/components/reports/report-list.tsx`)
Client Component로 구현된 인터랙티브 리포트 목록.

#### 주요 기능
- **타입 필터 탭**: 전체/견적서/체크리스트
- **카드 그리드 레이아웃**: 반응형 (1~3열)
- **카드 정보**:
  - 타입 아이콘 & 뱃지
  - 수주번호
  - 생성일 (date-fns로 포맷)
  - 파일 크기 (KB/MB 단위)
- **액션 버튼**:
  - 다운로드: Signed URL 생성 후 새 창으로 열기
  - 삭제: AlertDialog로 확인 후 삭제
- **상태 관리**:
  - `downloadingId`: 다운로드 진행 중 버튼 비활성화
  - `isPending`: 삭제 진행 중 버튼 비활성화
- **Toast 알림**: 성공/실패 메시지

#### 의존성
- `date-fns`: 날짜 포맷팅 (새로 설치)
- `shadcn/ui`: AlertDialog 컴포넌트 추가

### 4. 사이드바 메뉴
`src/components/layout/sidebar.tsx`에 이미 "리포트" 메뉴가 있음 (FileText 아이콘, /reports 경로).

## 기술 결정

### 왜 DB 테이블 없이 Storage만 사용했나?
1. **단순성**: 별도 테이블 마이그레이션 불필요
2. **동기화 불필요**: Storage와 DB 간 일관성 유지 오버헤드 제거
3. **메타데이터 충분**: 파일명과 폴더 구조로 필요한 정보 모두 표현 가능
4. **확장 가능**: 향후 필요 시 DB 테이블 추가 가능 (Storage 구조 유지)

### Path 구조 설계
`{user_id}/{order_id}/{type}_{timestamp}.pdf`

- **user_id**: RLS 정책 기반 접근 제어
- **order_id**: 수주별 리포트 그룹화
- **type + timestamp**: 파일 고유성 보장, 타입 필터링 용이

## 다음 단계 (TODO)

### 1. Supabase Storage RLS 설정
현재 코드는 RLS가 설정된 것으로 가정하고 작성됨. 실제 Supabase 대시보드에서 설정 필요:

```sql
-- reports bucket에 대한 RLS 정책
CREATE POLICY "Users can upload their own reports"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'reports' AND (storage.foldername(name))[1] = auth.uid()::text);

CREATE POLICY "Users can read their own reports"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'reports' AND (storage.foldername(name))[1] = auth.uid()::text);

CREATE POLICY "Users can delete their own reports"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'reports' AND (storage.foldername(name))[1] = auth.uid()::text);
```

### 2. PDF 생성 시 자동 저장 옵션
현재 견적서/체크리스트 PDF 다운로드 버튼에 "저장" 옵션 추가 필요.

예상 위치:
- `src/components/orders/order-quotation-preview.tsx`
- `src/components/orders/order-checklist-preview.tsx`

```tsx
// 예시
<Button onClick={handleSaveToStorage}>
  <Save className="h-4 w-4 mr-2" />
  Storage에 저장
</Button>
```

### 3. 수주 상세 페이지에서 리포트 목록 표시
`/orders/[id]` 페이지에 해당 수주의 저장된 리포트 목록 표시.

```tsx
// src/app/(dashboard)/orders/[id]/page.tsx에 추가
const reports = await getReports({ orderId: id });
<ReportList reports={reports.data || []} />
```

## 주의사항

### Supabase Storage Bucket
코드에서 bucket 생성을 시도하지만, Supabase 대시보드나 마이그레이션에서 수동 생성 권장:

```sql
-- Migration에 추가
INSERT INTO storage.buckets (id, name, public, file_size_limit)
VALUES ('reports', 'reports', false, 10485760);
```

### 파일명 파싱
현재 정규표현식: `/^(quotation|checklist)_(\d+)\.pdf$/`

새로운 리포트 타입 추가 시 이 패턴 업데이트 필요.

### 성능 고려사항
`getReports()` 함수는 user의 모든 order 폴더를 순회함. 수주가 많아지면 성능 이슈 발생 가능.

향후 최적화:
1. Pagination 도입
2. DB 테이블로 마이그레이션 (인덱싱)
3. Supabase Storage list API의 prefix 활용

## 빌드 확인

```bash
npm run build
```

**결과**: ✅ 통과 (타입 체크 및 린트 성공)

### 부수적 수정
빌드 과정에서 발견된 타입 에러 수정:
1. `src/app/api/pdf/route.ts`: `orderData.customer` 배열 처리
2. `src/components/closet/parts-palette.tsx`: `preset_data` 타입 명시

## 설치된 패키지
- `date-fns`: 날짜 포맷팅
- `shadcn/ui alert-dialog`: 삭제 확인 다이얼로그

## 검증 체크리스트
- [x] Server Actions 구현 (저장/조회/삭제/다운로드)
- [x] 리포트 목록 페이지 구현
- [x] ReportList 컴포넌트 구현
- [x] 타입 필터 (Tabs)
- [x] 다운로드 기능 (Signed URL)
- [x] 삭제 기능 (AlertDialog)
- [x] 파일 크기 포맷팅
- [x] 날짜 포맷팅 (date-fns)
- [x] 빌드 통과
- [x] LSP 진단 클린

## 알려진 이슈
없음.

## 참고
- Supabase Storage 문서: https://supabase.com/docs/guides/storage
- Supabase RLS 정책: https://supabase.com/docs/guides/storage/security/access-control
