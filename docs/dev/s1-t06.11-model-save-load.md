# T6.11 모델 저장/불러오기 (JSONB)

## 작업 개요
3D 에디터의 컴포넌트 배치 데이터를 수주(order)별로 저장하고 불러오는 기능 구현

## 완료 항목

### 1. Server Actions 생성 (`src/app/(dashboard)/closet/model-actions.ts`)
- `saveClosetModel(orderId, modelData)`: orders 테이블의 model_scene_data JSONB 칼럼에 저장
- `loadClosetModel(orderId)`: orders 테이블에서 모델 데이터 불러오기
- ModelData 타입: `{ components: ClosetComponent[], gridSize: number, version: number }`
- Supabase Auth: `getUser()` 사용하여 인증 확인
- 사용자별 권한 체크: `user_id` 필터 적용

### 2. ModelSaveBar 컴포넌트 추가 (`closet-editor.tsx`)
- orderId prop 전달 받음
- orderId가 있으면 자동으로 모델 로드 (useEffect)
- 저장 버튼: 현재 EditorState를 ModelData로 변환하여 저장
- Loading 상태 표시 (불러오기 중)
- Saving 상태 표시 (저장 중)
- Toast 알림: 성공/실패 메시지

### 3. Props 전달 체인
- `editor/page.tsx`: searchParams에서 `orderId` 파라미터 읽기
- `closet-editor-dynamic.tsx`: orderId prop 전달
- `closet-editor.tsx`: orderId prop 수신 및 ModelSaveBar에 전달

### 4. URL 구조
- `/closet/editor` - 기본 에디터 (저장 불가 상태)
- `/closet/editor?orderId=xxx` - 수주별 에디터 (자동 로드 + 저장 가능)

## 주요 결정사항

### JSONB 저장 위치
- `orders.model_scene_data` 칼럼 사용 (기존 schema에 이미 정의됨)
- EditorState 전체가 아닌 components와 gridSize만 저장 (UI 상태는 제외)

### 자동 로드 전략
- orderId가 있으면 컴포넌트 마운트 시 자동으로 loadClosetModel 호출
- EditorContext의 LOAD_STATE action으로 상태 복원
- 불러오기 실패 시 toast.error로 사용자에게 알림

### 오류 처리
- Server Actions: ActionResult<T> 타입으로 success/error 명시적 반환
- DB 오류 시 graceful 처리: console.error + ActionResult.error 반환
- 클라이언트: toast.error로 사용자에게 오류 표시

### 타입 안전성
- `as any` 사용: JSONB 칼럼은 DB 타입이 unknown이므로 type assertion 필요
- loadClosetModel에서 구조 검증: components 배열, gridSize 숫자, version 숫자 확인

## 알려진 이슈

### ESLint Warnings (빌드 성공, 기능 정상)
- `model-actions.ts:38:48`: `model_scene_data: modelData as any` - JSONB 타입 불일치로 인한 any 사용 불가피
- `model-actions.ts:89:48`: `const modelData = data.model_scene_data as any` - 동일한 이유

### 미구현 기능
- 수정 중 자동 저장 (Auto-save): 현재는 수동 저장만 지원
- 저장 히스토리 / 버전 관리: version 필드는 있지만 아직 활용 안 함
- 저장 전 변경사항 감지: 저장 버튼 활성화 조건 없음

## 다음 단계
- T6.12: 자동 저장 (5초마다 또는 변경 후 debounce)
- T7.x: 수주 상세 페이지에서 에디터 링크 추가 (orderId 전달)
- T8.x: 모델 히스토리 관리 (버전별 복원 기능)

## 검증 결과
- ✅ `npm run build` 성공 (ESLint warnings는 의도된 any 사용)
- ✅ LSP diagnostics: 모든 파일 TypeScript 오류 없음
- ✅ 새 파일 생성: `model-actions.ts`
- ✅ 기존 파일 수정: `closet-editor.tsx`, `closet-editor-dynamic.tsx`, `editor/page.tsx`
- ✅ 파일 소유권 준수: canvas, mesh, toolbar 미수정
